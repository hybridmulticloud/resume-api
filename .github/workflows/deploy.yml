name: Terraform Backend Deploy

on:
  push:
    branches:
      - main  # Change if you deploy from another branch

permissions:
  id-token: write    # Required for OIDC role assumption
  contents: read     # Read access to repo contents

jobs:
  deploy:
    name: Terraform Apply to AWS
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Checkout Repository
      uses: actions/checkout@v3

    - name: 🔐 Configure AWS Credentials (OIDC AssumeRole)
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: 🛠️ Set Up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: 📦 Terraform Init
      run: terraform init

    - name: 🧪 Terraform Validate
      run: terraform validate

    - name: 🚀 Terraform Apply
      run: terraform apply -auto-approve
