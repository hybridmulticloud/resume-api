name: Terraform Backend Deploy

on:
  push:
    branches:
      - main  # Change if you deploy from another branch

permissions:
  id-token: write    # Required for OIDC role assumption
  contents: read     # Read access to repo contents

jobs:
  deploy:
    name: Terraform Apply to AWS
    runs-on: ubuntu-latest

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸ” Configure AWS Credentials (OIDC AssumeRole)
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: ğŸ› ï¸ Set Up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: ğŸ“¦ Terraform Init
      run: terraform init

    - name: ğŸ§ª Terraform Validate
      run: terraform validate

    - name: ğŸš€ Terraform Apply
      run: terraform apply -auto-approve
